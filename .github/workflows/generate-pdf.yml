name: Generate Resume PDF

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # PASSO DE DEBUG: Lista os arquivos para ter certeza do nome exato
      - name: Debug File List
        run: ls -la

      # Instala uma biblioteca mais moderna (md-to-pdf)
      - name: Install PDF Converter
        run: npm install -g md-to-pdf

      - name: Create output directory
        run: mkdir -p output

      # Converte considerando nomes comuns de arquivo (README.md ou readme.md)
      - name: Convert MD to PDF
        run: |
          # Verifica se existe README.md ou readme.md e define a variável FILE
          if [ -f "README.md" ]; then
            FILE="README.md"
          elif [ -f "readme.md" ]; then
            FILE="readme.md"
          else
            echo "ERRO: Arquivo README.md não encontrado!"
            exit 1
          fi

          echo "Convertendo arquivo: $FILE"

          # Executa a conversão
          # O --launch-options corrige problemas de permissão no ambiente Linux
          npx md-to-pdf "$FILE" --stylesheet style.css --pdf-options '{ "format": "A4", "margin": "15mm", "printBackground": true }' --launch-options '{ "args": ["--no-sandbox"] }'

          # O md-to-pdf gera o PDF com o mesmo nome do MD (ex: README.pdf). Vamos mover para output/
          mv "${FILE%.*}.pdf" output/resume.pdf

      - name: Commit PDF
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add output/resume.pdf
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update Resume PDF [Skip CI]" && git push)